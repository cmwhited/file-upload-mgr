AWSTemplateFormatVersion: 2010-09-09
Transform:
- AWS::Serverless-2016-10-31
- AWS::CodeStar

Parameters:
  ProjectId:
    Type: String
    Description: AWS CodeStar projectID used to associate new resources to team members
  Stage:
    Type: String
    Description: The name for a project pipeline stage, such as Staging or Prod, for which resources are provisioned and deployed.
    Default: 'Dev'

Resources:
  FileUploadMgrHandler:
    Type: AWS::Serverless::Function
    Properties:
      Handler: main
      Runtime: go1.x
      Timeout: 10
      Environment:
        Variables:
          JWT_SECRET: kqivVVuYGZRxsI8S14en
          TOKEN_EXPIRY_MIN: 60
          USERS_TABLE_NAME: users
          SESSIONS_TABLE_NAME: sessions
      Role:
        Fn::GetAtt:
        - LambdaExecutionRole
        - Arn
      Events:
        PostGraphQlEvent:
          Type: Api
          Properties:
            Path: /graphql
            Method: post
        GetGraphQlEvent:
          Type: Api
          Properties:
            Path: /graphql
            Method: get
  LambdaExecutionRole:
    Description: Creating service role in IAM for AWS Lambda
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'CodeStar-${ProjectId}-Execution${Stage}'
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: [lambda.amazonaws.com]
          Action: sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        -  arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        -  arn:aws:iam::260345904678:policy/DynamoDbAccessPolicy
      PermissionsBoundary: !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:policy/CodeStar_${ProjectId}_PermissionsBoundary'
  UsersTable:
    Description: DynamoDB SimpleTable for storing Users
    Type: AWS::Serverless::SimpleTable
    Properties:
      TableName: users
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 1
      PrimaryKey:
        Name: id
        Type: String
  SessionsTable:
    Description: DynamoDB Table for storing file sessions for the uploads
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: sessions
      ProvisionedThroughput:
        ReadCapacityUnits: 2
        WriteCapacityUnits: 2
      AttributeDefinitions:
        - AttributeName: 'id'
          AttributeType: 'S'
        - AttributeName: 'user_id'
          AttributeType: 'S'
      KeySchema:
        - AttributeName: "id"
          KeyType: "HASH"
        - AttributeName: "user_id"
          KeyType: "RANGE"